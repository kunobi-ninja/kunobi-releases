name: Update Release

on:
  repository_dispatch:
    types: [update-release]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update to (without v prefix)'
        required: true
      channel:
        description: 'Release channel (stable, unstable)'
        required: true
        type: choice
        options:
          - stable
          - unstable

jobs:
  update-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.params.outputs.version }}
      channel: ${{ steps.params.outputs.channel }}
      changed: ${{ steps.diff.outputs.changed }}
      branch: ${{ steps.branch.outputs.name }}
    steps:
      - uses: actions/checkout@v4

      - name: Get version and channel
        id: params
        env:
          DISPATCH_VERSION: ${{ github.event.client_payload.version }}
          DISPATCH_CHANNEL: ${{ github.event.client_payload.channel }}
          INPUT_VERSION: ${{ github.event.inputs.version }}
          INPUT_CHANNEL: ${{ github.event.inputs.channel }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [ "$EVENT_NAME" = "repository_dispatch" ]; then
            VERSION="$DISPATCH_VERSION"
            CHANNEL="$DISPATCH_CHANNEL"
          else
            VERSION="$INPUT_VERSION"
            CHANNEL="$INPUT_CHANNEL"
          fi

          if [ -z "$VERSION" ] || [ -z "$CHANNEL" ]; then
            echo "Error: version and channel are required" >&2
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "channel=$CHANNEL" >> $GITHUB_OUTPUT
          echo "Updating to version: $VERSION (channel: $CHANNEL)"

      - name: Download release assets from R2
        env:
          VERSION: ${{ steps.params.outputs.version }}
        run: |
          BASE_URL="https://r2.kunobi.ninja/v${VERSION}"
          VERSIONED_FILE="Kunobi_${VERSION}_release_assets.json"

          curl -fSL "${BASE_URL}/${VERSIONED_FILE}" -o release_assets.json
          curl -fSL "${BASE_URL}/${VERSIONED_FILE}.sha256" -o release_assets.json.sha256

          ls -lh release_assets.json release_assets.json.sha256

      - name: Check for changes
        id: diff
        run: |
          if git diff --quiet release_assets.json 2>/dev/null; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Release already up to date, skipping"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Push update branch
        if: steps.diff.outputs.changed == 'true'
        id: branch
        env:
          VERSION: ${{ steps.params.outputs.version }}
        run: |
          BRANCH="auto/update-v${VERSION}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add release_assets.json release_assets.json.sha256
          git commit -m "Update Kunobi to v${VERSION}"
          git push --force-with-lease origin "$BRANCH"
          echo "name=$BRANCH" >> $GITHUB_OUTPUT

  validate:
    needs: update-release
    if: needs.update-release.outputs.changed == 'true'
    uses: ./.github/workflows/validate-release.yaml
    with:
      ref: ${{ needs.update-release.outputs.branch }}

  cleanup:
    needs: [update-release, validate]
    if: >-
      always()
      && needs.validate.result == 'failure'
      && needs.update-release.outputs.branch != ''
      && needs.update-release.outputs.branch != 'main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Delete failed branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ needs.update-release.outputs.branch }}
        run: |
          gh api -X DELETE "repos/$GITHUB_REPOSITORY/git/refs/heads/$BRANCH" || true
          echo "Deleted branch $BRANCH after failed validation"

  create-pr:
    needs: [update-release, validate]
    if: needs.update-release.outputs.changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.update-release.outputs.version }}
          CHANNEL: ${{ needs.update-release.outputs.channel }}
          BRANCH: ${{ needs.update-release.outputs.branch }}
        run: |
          gh pr create \
            --repo "$GITHUB_REPOSITORY" \
            --head "$BRANCH" \
            --base main \
            --title "Update Kunobi to v${VERSION}" \
            --body "$(cat <<EOF
          Auto-generated and validated by update-release workflow

          - **Version**: ${VERSION}
          - **Channel**: ${CHANNEL}
          - **Release assets**: Verified (sha256 match)
          EOF
          )"
